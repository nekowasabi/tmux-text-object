# Implementation Insights - text-object

**Date**: 2025-11-12T07:40:50
**Feature**: text-object
**Phase**: Implementation

---

## Code Changes Summary

### Modified Files
- `scripts/text-object-yank.sh` (+84, -12 lines) - yip段落コピー機能の修正：デバッグモード追加、座標計算の改善、mapfile問題の解決

### Added Files
- `tests/test_integration.sh` (357 lines) - 統合テストスイートの追加
- `tests/test_paragraph_range.sh` (357 lines) - 段落範囲テストの追加

**Statistics**:
- Total Files Changed: 3
- Lines Added: +798
- Lines Removed: -12
- Net Change: +786 lines

---

## Design Rationale

### Decision 1: 絶対パス /opt/homebrew/bin/tmux の使用

**Reasoning**: tmux run-shell環境ではPATHが制限されており、which tmuxすら失敗する。確実な実行のため、開発環境の標準パスを明示的に指定

**Trade-offs**:
- ✅ **Pros**:
  - シンプルで理解しやすい
  - エラーケースが少ない
- ❌ **Cons**:
  - macOS Homebrew環境限定（移植性低）
  - Linuxや他のパッケージマネージャで動作しない

**Context**: tmux run-shell/runコマンドは最小限のシェル環境で実行され、標準的なPATH設定が適用されない

**Recommendation**: 将来的には環境変数TMUX_BINでオーバーライド可能にするか、フォールバックメカニズムを導入することを検討

---

### Decision 2: mapfileから一時ファイル+while loopへの変更

**Reasoning**: mapfileはbash組み込みだがtmux run-shell環境で利用不可。また、プロセス置換<()はset -u環境で未定義変数エラーを引き起こす

**Trade-offs**:
- ✅ **Pros**:
  - POSIX互換性が高い
  - set -u環境で安定動作
  - tmux run-shell環境で確実に動作
- ❌ **Cons**:
  - ディスクI/Oが発生
  - 一時ファイルのクリーンアップが必要

**Context**: bash 4+のmapfileコマンドは通常環境では利用可能だが、tmux run-shell環境では組み込みコマンドとして認識されない（exit code 127エラー）

**Implementation**:
```bash
# Before (mapfile - 失敗)
mapfile -t lines < <(command)

# After (POSIX互換 - 成功)
tmpfile=$(mktemp)
command > "$tmpfile"
while IFS= read -r line; do
  lines+=("$line")
done < "$tmpfile"
rm -f "$tmpfile"
```

---

## Problems & Solutions

### Problem 1: yipコマンド実行時に「ERROR: mapfile failed」エラー（exit code 127）

**Issue**: tmuxのキーバインド（prefix + yip）を実行すると、「ERROR: mapfile failed」が表示され、段落のヤンクが失敗する

**Root Cause**: tmux run-shell環境ではPATHが最小限で、mapfileがbash組み込みコマンドとして認識されない。環境が制限されているため、通常のシェルで動作するコードがtmux内では失敗する

**Solution**:
```bash
# mapfileを完全に廃止し、POSIXレベルのwhile read loopパターンに変更
# 一時ファイル経由でデータを読み込む方式に統一

# 段落行の読み込み
temp_file=$(mktemp)
/opt/homebrew/bin/tmux capture-pane -p -S - -E - > "$temp_file"

line_num=0
declare -a lines
while IFS= read -r line; do
  lines[$line_num]="$line"
  ((line_num++))
done < "$temp_file"

rm -f "$temp_file"
```

**Time Spent**: 約2時間

**Prevention**: tmuxプラグイン開発では、全てのコマンドを絶対パス指定し、bash組み込みコマンド（mapfile, readarray等）の使用を避け、POSIXレベルのシェルコマンドのみを使用する

---

### Problem 2: スクロール位置によってyipの動作が不安定

**Issue**: 画面をスクロールした状態でyipを実行すると、意図しない段落がコピーされたり、範囲計算が不正確になる

**Root Cause**: cursor_yは画面内の相対座標であり、スクロール位置が変わると同じ段落でも異なるcursor_yになる。スクロールバック履歴を考慮した絶対座標への変換が不足していた

**Solution**:
```bash
# tmuxの座標系を理解し、絶対座標計算式を導出
history_size=$(/opt/homebrew/bin/tmux display-message -p '#{history_size}')
scroll_position=$(/opt/homebrew/bin/tmux display-message -p '#{scroll_position}')
cursor_y=$(/opt/homebrew/bin/tmux display-message -p '#{cursor_y}')

# 絶対行番号 = history_size - scroll_position + cursor_y
absolute_line=$((history_size - scroll_position + cursor_y))

# デバッグモードでの確認
if [[ "${TMUX_TEXT_OBJECT_DEBUG:-0}" == "1" ]]; then
  /opt/homebrew/bin/tmux display-message "Coords: history=$history_size scroll=$scroll_position cursor=$cursor_y -> abs=$absolute_line"
fi
```

**Time Spent**: 約1.5時間

**Prevention**: tmuxの座標系を扱う際は、常にhistory_size、scroll_position、cursor_yの3要素を考慮し、絶対座標への変換を最初に実行する

---

## Learnings & Insights

### Learning 1: tmux run-shell環境はPATHが極めて制限的で、bash組み込みコマンドも使えない

**What I Learned**: tmux run-shell/runコマンド内で実行されるスクリプトは、通常のシェル環境とは大きく異なる。PATHが制限され、bashの組み込みコマンド（mapfile, declare -A等）が認識されない環境で動作する

**Context**: yipコマンドのデバッグ中に、ローカルシェルでは正常に動作するコードがtmux内で失敗することを発見。exit code 127（command not found）が頻発

**Takeaway**: tmuxプラグイン開発では、全ての外部コマンドを絶対パス指定する。bash組み込みコマンドは使用せず、POSIXレベルのシェルコマンドのみを使用する

**Code Example**:
```bash
# ❌ 悪い例（tmux run-shell環境で失敗）
mapfile -t lines < <(tmux capture-pane -p)
which tmux  # PATHが制限されているため失敗

# ✅ 良い例（tmux run-shell環境で動作）
tmpfile=$(mktemp)
/opt/homebrew/bin/tmux capture-pane -p > "$tmpfile"
while IFS= read -r line; do
  lines+=("$line")
done < "$tmpfile"
rm -f "$tmpfile"
```

**Future Application**: 今後のtmuxプラグイン開発では、開発初期段階からtmux run-shell環境を前提としたコーディング規約を適用する

---

### Learning 2: tmuxの座標系は history_size, scroll_position, cursor_y の3要素で構成される

**What I Learned**: tmuxの画面座標は単純なx, y座標ではなく、スクロールバック履歴を含む3次元的な座標系で管理されている。カーソルのy座標は画面内相対位置であり、絶対的な行番号ではない

**Context**: スクロール位置によってyipの動作が変わる問題を調査中に、tmuxの座標系の仕組みを理解する必要があった

**Takeaway**: 絶対行番号 = history_size - scroll_position + cursor_y という公式を覚える。この計算により、スクロール位置に依存しない安定した座標変換が可能になる

**Code Example**:
```bash
# tmux座標系の取得
history_size=$(/opt/homebrew/bin/tmux display-message -p '#{history_size}')
scroll_position=$(/opt/homebrew/bin/tmux display-message -p '#{scroll_position}')
cursor_y=$(/opt/homebrew/bin/tmux display-message -p '#{cursor_y}')

# 絶対座標への変換
absolute_line=$((history_size - scroll_position + cursor_y))

# 段落範囲の絶対座標計算
abs_start_line=$((history_size - scroll_position + start_line))
abs_end_line=$((history_size - scroll_position + end_line))
```

**Future Application**: テキストオブジェクトの拡張（行オブジェクト、関数オブジェクト等）でも同じ座標変換ロジックを適用できる

---

### Learning 3: 環境変数ベースのデバッグモードは非対話的環境で非常に有効

**What I Learned**: tmux run-shell環境のように非対話的で出力が制限された環境では、環境変数によるデバッグモード切り替えが極めて有効。printfデバッグよりもtmux display-messageによるステータスライン出力が視認性が高い

**Context**: yipのバグ調査中、通常のecho/printfデバッグが機能しないため、代替手段を模索

**Takeaway**: DEBUG_MODE環境変数で条件分岐し、tmux display-messageでステータスライン出力する設計パターンを採用する

**Code Example**:
```bash
# デバッグモードの判定
DEBUG_MODE="${TMUX_TEXT_OBJECT_DEBUG:-0}"

if [[ "$DEBUG_MODE" == "1" ]]; then
  /opt/homebrew/bin/tmux display-message "DEBUG: cursor_y=$cursor_y, absolute=$absolute_line"
fi

# 使用方法
# ~/.tmux.conf または実行時に設定
set-environment -g TMUX_TEXT_OBJECT_DEBUG 1
```

**Future Application**: 他のテキストオブジェクト（単語、行、関数等）にも同じデバッグインフラを適用し、統一的なデバッグ体験を提供

---

## Pattern Recognition

### 1. tmux run-shell環境の制約パターン (信頼度: 98%)

**Description**: tmux run-shell/run内ではPATHが制限され、bashの組み込みコマンド（mapfile等）が利用不可能。絶対パス指定とシンプルなwhile loopパターンが必要

**Affected Files**:
- `scripts/text-object-yank.sh`

**Pattern Details**:
- 全てのtmuxコマンド呼び出しを絶対パス（/opt/homebrew/bin/tmux）で実行
- mapfile/readarrayの代わりに一時ファイル+while read loopを使用
- プロセス置換 <() の使用を避ける

**Recommendation**: tmuxプラグイン開発のベストプラクティスとして文書化し、他のスクリプトにも適用

---

### 2. 座標計算の統一化パターン (信頼度: 95%)

**Description**: tmuxのスクロール位置（history_size, scroll_position, cursor_y）を考慮した絶対座標計算を、段落検出とテキスト抽出の両方で統一

**Affected Files**:
- `scripts/text-object-yank.sh`

**Pattern Details**:
- 座標取得処理を関数化（get_absolute_coordinates）
- 絶対座標変換式を一箇所に集約
- スクロール位置に依存しない安定した動作を実現

**Recommendation**: 座標計算ロジックを共有ライブラリ（lib/coordinates.sh等）に分離し、再利用性を高める

---

### 3. デバッグ可能性の向上パターン (信頼度: 90%)

**Description**: 環境変数ベースのデバッグモード（TMUX_TEXT_OBJECT_DEBUG）導入により、本番とデバッグの切り替えを容易に

**Affected Files**:
- `scripts/text-object-yank.sh`

**Pattern Details**:
- 環境変数による条件分岐
- tmux display-messageによる非侵襲的な情報表示
- 座標、範囲、実行フローの可視化

**Recommendation**: 全てのテキストオブジェクトスクリプトに同じデバッグインフラを導入し、統一的なデバッグ体験を提供

---

## Impact Analysis

### High: tmuxプラグインの信頼性

**Affected Components**:
- yip/yap (段落ヤンク)
- カーソル位置計算
- スクロールバック処理

**Impact Details**:
- yipコマンドがスクロール位置に関わらず正確に動作
- mapfileエラーが完全に解消
- ユーザー体験の向上（エラーメッセージの減少）

**Potential Issues**:
- 絶対パス依存による移植性の低下（macOS Homebrew環境限定）
- 一時ファイルI/Oによるパフォーマンス影響（微小）

**Mitigation**:
- TMUX_BIN環境変数によるオーバーライド機構の追加を検討
- 一時ファイルのクリーンアップを確実に実行（trapハンドラの追加）

---

### Medium: デバッグとメンテナンス性

**Affected Components**:
- デバッグログ出力
- エラーハンドリング

**Impact Details**:
- 環境変数ベースのデバッグモードにより、問題調査が容易に
- tmux display-messageによる可視化で、座標計算の検証が簡単に

**Potential Issues**:
- デバッグモードのドキュメント不足
- デバッグメッセージが多すぎると視認性が低下

**Mitigation**:
- README.mdにデバッグモードの使用方法を記載
- デバッグレベル（0: OFF, 1: INFO, 2: DEBUG）の段階的導入を検討

---

## Risk Assessment

### High: 絶対パスのハードコーディング（/opt/homebrew/bin/tmux）

**Description**: スクリプト内でtmuxコマンドの絶対パスを/opt/homebrew/bin/tmuxにハードコーディングしているため、macOS Homebrew環境以外では動作しない

**Impact**:
- Linux環境（/usr/bin/tmux）で動作しない
- 他のパッケージマネージャ（MacPorts, Nix等）で動作しない
- ユーザーがカスタムパスにインストールしている場合に動作しない

**Mitigation**:
1. 環境変数TMUX_BINでオーバーライド可能にする
   ```bash
   TMUX_BIN="${TMUX_BIN:-/opt/homebrew/bin/tmux}"
   ```
2. フォールバックメカニズムを追加
   ```bash
   if command -v tmux >/dev/null 2>&1; then
     TMUX_BIN=$(command -v tmux)
   else
     TMUX_BIN="/opt/homebrew/bin/tmux"
   fi
   ```
3. インストールスクリプトで自動検出してパスを設定

**Priority**: High（移植性に直結）

---

### Medium: 一時ファイルのクリーンアップ漏れ

**Description**: mapfileの代替として一時ファイルを使用しているが、スクリプトがエラー終了した場合にクリーンアップされない可能性がある

**Impact**:
- /tmp ディレクトリに一時ファイルが蓄積
- ディスク容量の浪費（軽微）
- セキュリティリスク（tmuxの画面内容が一時的にファイルに保存される）

**Mitigation**:
1. trapコマンドでクリーンアップハンドラを追加
   ```bash
   tmpfile=$(mktemp)
   trap 'rm -f "$tmpfile"' EXIT INT TERM
   ```
2. スクリプト終了時に確実に削除
3. 機密性の高い情報を扱う場合は、mktemp --dry-runでパスのみ生成し、即座に削除

**Priority**: Medium（実害は少ないが、ベストプラクティスとして実装すべき）

---

## Domain Knowledge

### tmux Architecture

tmuxのrun-shell/runコマンは最小限のシェル環境で実行され、PATHやbash組み込みコマンドの利用が制限される

**Key Insights**:
- run-shell環境では環境変数PATHがほぼ空
- bashの組み込みコマンド（mapfile, readarray, declare -A等）が認識されない
- which, type等のコマンド検索も失敗する
- 外部コマンドは絶対パス指定が必須

**Implications**:
- tmuxプラグイン開発では、通常のシェルスクリプト開発とは異なるアプローチが必要
- POSIX互換性を最優先に考慮
- テストは必ずtmux run-shell環境で実施

---

### tmux Coordinate System

絶対位置 = history_size - scroll_position + cursor_y という計算式が重要

**Coordinate Components**:
1. **history_size**: スクロールバック履歴の行数
2. **scroll_position**: 現在のスクロール位置（0 = スクロールなし）
3. **cursor_y**: 画面内のカーソル相対位置（0-indexed）

**Calculation Formula**:
```bash
absolute_line = history_size - scroll_position + cursor_y
```

**Example**:
- history_size = 1000 (1000行のスクロールバック履歴)
- scroll_position = 50 (50行上にスクロール)
- cursor_y = 10 (画面内の11行目)
- absolute_line = 1000 - 50 + 10 = 960 (履歴上の960行目)

**Implications**:
- スクロール位置に依存しない範囲計算が可能
- 段落の開始/終了行を絶対座標で管理
- 複数ペインでも一貫した座標系

---

### Shell Scripting Portability

mapfileはbash 4+の組み込みコマンドだが、tmux run-shell環境では利用不可。POSIXレベルのwhile read loopが最も移植性が高い

**Best Practices**:
1. **配列の読み込み**:
   ```bash
   # ❌ bash組み込み（tmux run-shellで失敗）
   mapfile -t lines < file.txt

   # ✅ POSIX互換（確実に動作）
   while IFS= read -r line; do
     lines+=("$line")
   done < file.txt
   ```

2. **連想配列の代替**:
   ```bash
   # ❌ bash 4+専用
   declare -A assoc
   assoc["key"]="value"

   # ✅ シンプルな配列+インデックス管理
   keys=("key1" "key2")
   values=("value1" "value2")
   ```

3. **プロセス置換の回避**:
   ```bash
   # ❌ プロセス置換（set -u環境で問題）
   while read line; do ...; done < <(command)

   # ✅ 一時ファイル経由
   tmpfile=$(mktemp)
   command > "$tmpfile"
   while read line; do ...; done < "$tmpfile"
   rm -f "$tmpfile"
   ```

---

## Next Steps

- [ ] **環境変数TMUX_BINの導入**: 絶対パスのハードコーディングを解消し、移植性を向上（Priority: High）
- [ ] **trapハンドラの追加**: 一時ファイルのクリーンアップを確実に実行（Priority: Medium）
- [ ] **座標計算ライブラリの分離**: `lib/coordinates.sh` を作成し、座標計算ロジックを再利用可能に（Priority: Medium）
- [ ] **統合テストの拡充**: スクロール位置の異なる状況でのyip/yapテストを追加（Priority: High）
- [ ] **デバッグモードのドキュメント化**: README.mdにTMUX_TEXT_OBJECT_DEBUGの使用方法を記載（Priority: Low）
- [ ] **Linux/BSD環境でのテスト**: macOS以外の環境でプラグインが動作するか検証（Priority: High）
- [ ] **パフォーマンス測定**: 一時ファイルI/Oが大きなバッファ（10000行以上）でも問題ないか検証（Priority: Low）

---

## Metadata

| 項目 | 値 |
|------|-----|
| 実行日時 | 2025-11-12T07:40:50 |
| Feature | text-object |
| 処理Agent | impl-insights-analyzer-git (haiku) |
| | impl-insights-extractor-insights (sonnet+thinking) |
| | impl-insights-generator-doc (sonnet) |
| コンテキスト削減率 | ~65% |
| ファイル数 | 3 files changed |
| 追加行数 | +798 lines |
| 削除行数 | -12 lines |
| 純変更 | +786 lines |

---

*Generated by `/impl-insights` at 2025-11-12T07:40:50*
